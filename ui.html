<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Planner</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f9f9f9;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 20px;
        }

        button:hover {
            background-color: #0056b3;
        }

        .electives-container {
            width: 100%;
            max-width: 800px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            background-color: #fff;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .electives-container.highlight {
            outline: 2px dashed #007bff;
        }

        .semester-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .semester {
            background-color: #fff;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .semester p {
            font-weight: bold;
            margin-bottom: 10px;
            color: #555;
        }

        .grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            min-height: 60px;
        }

        .grid.highlight {
            outline: 2px dashed #007bff;
        }

        .square {
            width: 50px;
            height: 50px;
            background-color: #e0e0e0;
            border: 1px solid #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            border-radius: 5px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .square:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .course {
            color: black;
            cursor: grab;
        }

        .course:active {
            cursor: grabbing;
        }

        .course-joined {
            width: calc(50px * var(--credits) + 10px * (var(--credits) - 1));
        }

        #info-message, #error-message {
            padding: 10px;
            border-radius: 5px;
            margin-top: 20px;
            display: none;
        }

        #info-message {
            background-color: #d4edda;
            color: #155724;
        }

        #error-message {
            background-color: #f8d7da;
            color: #721c24;
        }

        @media (max-width: 768px) {
            .square {
                width: 40px;
                height: 40px;
                font-size: 10px;
            }

            .course-joined {
                width: calc(40px * var(--credits) + 10px * (var(--credits) - 1));
            }
        }
    </style>
</head>
<body>
    <h1>Course Planner</h1>
    <button id="clear-button">Clear Planner</button>
    <div id="electives" class="electives-container"></div>
    <div id="semesters" class="semester-container"></div>
    <div id="info-message"></div>
    <div id="error-message"></div>

    <script type="module" src="courses.js"></script>
    <script type="module">
        import { courses } from './courses.js';

        const semestersContainer = document.getElementById('semesters');
        const courseDependencies = {};

        courses.forEach(course => {
            course.prerequisites.forEach(prerequisite => {
                if (!courseDependencies[prerequisite]) {
                    courseDependencies[prerequisite] = [];
                }
                courseDependencies[prerequisite].push(course.short_name);
            });
        });

        for (let semester = 1; semester <= 7; semester++) {
            const semesterDiv = document.createElement('div');
            semesterDiv.className = 'semester';
            semesterDiv.dataset.number = semester;

            const semesterTitle = document.createElement('p');
            semesterTitle.textContent = `${semester}. Semester`;
            semesterDiv.appendChild(semesterTitle);

            const gridDiv = document.createElement('div');
            gridDiv.className = 'grid';

            const semesterCourses = courses.filter(course => course.intended_semester === semester);
            semesterCourses.forEach(course => {
                const credits = course.credits / 3;
                const courseSquare = createCourseSquare(course, credits);
                gridDiv.appendChild(courseSquare);
            });

            semesterDiv.appendChild(gridDiv);
            semestersContainer.appendChild(semesterDiv);
        }

        const electivesDiv = document.getElementById('electives');
        const electivesCourses = courses.filter(course => course.elective === true);
        electivesCourses.forEach(course => {
            const credits = course.credits / 3;
            const courseSquare = createCourseSquare(course, credits);
            electivesDiv.appendChild(courseSquare);
        });

        function createCourseSquare(course, credits) {
            const courseSquare = document.createElement('div');
            courseSquare.className = 'square course course-joined';
            courseSquare.style.setProperty('--credits', credits);
            courseSquare.textContent = course.short_name;
            courseSquare.draggable = true;
            courseSquare.id = `course-${course.id}`;
            courseSquare.style.backgroundColor = course.color;

            courseSquare.dataset.short_name = course.short_name;
            courseSquare.dataset.name = course.name;
            courseSquare.dataset.credits = course.credits;
            courseSquare.dataset.credits_needed = course.credits_needed;
            courseSquare.dataset.semester = course.semester;
            courseSquare.dataset.intendedSemester = course.intended_semester;
            courseSquare.dataset.prerequisites = JSON.stringify(course.prerequisites);
            courseSquare.dataset.isElective = course.elective;

            courseSquare.addEventListener('dragstart', dragStart);
            courseSquare.addEventListener('dragover', dragOver);
            courseSquare.addEventListener('drop', drop);

            return courseSquare;
        }

        let draggedCourse = null;

        function dragStart(event) {
            draggedCourse = event.target;
            event.dataTransfer.setData('text/plain', event.target.id);
            document.querySelectorAll('.semester').forEach(semesterDiv => {
                const isWinterSemesterDragStart = semesterDiv.dataset.number % 2 !== 0;
                const draggedSquareSemesterType = draggedCourse.dataset.semester;

                if (draggedSquareSemesterType === 'summer' && isWinterSemesterDragStart) {
                    semesterDiv.style.opacity = '0.3';
                } else if (draggedSquareSemesterType === 'winter' && !isWinterSemesterDragStart) {
                    semesterDiv.style.opacity = '0.3';
                } else {
                    semesterDiv.style.opacity = '1';
                }
            });
        }

        function restoreOpacity() {
            document.querySelectorAll('.semester').forEach(semesterDiv => {
                semesterDiv.style.opacity = '1';
            });
        }

        function dragOver(event) {
            event.preventDefault();
            event.target.closest('.grid, #electives')?.classList.add('highlight');
        }

        function drop(event) {
            event.preventDefault();
            restoreOpacity();

            const target = event.target.closest('.grid, #electives');
            if (!target || !draggedCourse) return;
            target.classList.remove('highlight');

            if (target.id === 'electives') {
                if (draggedCourse.dataset.isElective !== "true") {
                    setErrorMessage("Only elective courses can be placed in the electives pool.");
                    return;
                }
                target.appendChild(draggedCourse);
                draggedCourse = null;
                clearErrorMessage();
                updateInfo();
                saveStateToLocalStorage();
                return;
            }

            const targetSemesterDiv = target.closest('.semester');
            const semesterNumber = parseInt(targetSemesterDiv.dataset.number);
            const isWinterSemester = semesterNumber % 2 !== 0;
            const courseSemesterType = draggedCourse.dataset.semester;

            if ((isWinterSemester && courseSemesterType === "summer") || (!isWinterSemester && courseSemesterType === "winter")) {
                setErrorMessage(`Cannot move ${draggedCourse.dataset.name} to semester ${semesterNumber}. Semester type mismatch.`);
                return;
            }

            const prerequisites = JSON.parse(draggedCourse.dataset.prerequisites);
            const creditsNeeded = parseInt(draggedCourse.dataset.credits_needed);
            const previousSemesters = Array.from(document.querySelectorAll('.semester'))
                .filter(semester => parseInt(semester.dataset.number) < semesterNumber);

            const completedCourses = new Set();
            let totalCreditsByPreviousSemester = 0;

            previousSemesters.forEach(semester => {
                const coursesInSemester = semester.querySelectorAll('.course');
                coursesInSemester.forEach(course => {
                    completedCourses.add(course.dataset.short_name);
                    const courseCredits = parseInt(course.dataset.credits, 10);
                    if (!isNaN(courseCredits)) {
                        totalCreditsByPreviousSemester += courseCredits;
                    }
                });
            });

            const prerequisitesMet = prerequisites.every(prerequisite => completedCourses.has(prerequisite));
            const missingPrerequisites = prerequisites.filter(prerequisite => !completedCourses.has(prerequisite));
            const gotNeededCredits = totalCreditsByPreviousSemester >= creditsNeeded;
            const creditDifference = creditsNeeded - totalCreditsByPreviousSemester;

            if (!prerequisitesMet) {
                setErrorMessage(`Cannot move ${draggedCourse.dataset.name} to semester ${semesterNumber}. Missing prerequisites: ${missingPrerequisites.join(', ')}.`);
                return;
            } else if (!gotNeededCredits) {
                setErrorMessage(`Cannot move ${draggedCourse.dataset.name} to semester ${semesterNumber}. You need ${creditDifference} more credits.`);
                return;
            }

            const courseName = draggedCourse.dataset.short_name;
            if (courseDependencies[courseName]) {
                for (const dependent of courseDependencies[courseName]) {
                    const dependentSemester = Array.from(document.querySelectorAll('.semester'))
                        .find(semester => semester.querySelector(`.course[data-short_name="${dependent}"]`))?.dataset.number;
                    if (dependentSemester && semesterNumber >= dependentSemester) {
                        setErrorMessage(`Moving ${courseName} will break prerequisites for ${dependent} (currently in semester ${dependentSemester}).`);
                        return;
                    }
                }
            }

            target.appendChild(draggedCourse);
            draggedCourse = null;
            clearErrorMessage();
            updateInfo();

            const lastSemester = document.querySelector('.semester:last-child');
            if (targetSemesterDiv === lastSemester) {
                const newSemesterNumber = parseInt(lastSemester.dataset.number) + 1;
                const newSemesterDiv = document.createElement('div');
                newSemesterDiv.className = 'semester';
                newSemesterDiv.dataset.number = newSemesterNumber;

                const newSemesterTitle = document.createElement('p');
                newSemesterTitle.textContent = `${newSemesterNumber}. Semester`;
                newSemesterDiv.appendChild(newSemesterTitle);

                const newGridDiv = document.createElement('div');
                newGridDiv.className = 'grid';
                newSemesterDiv.appendChild(newGridDiv);

                semestersContainer.appendChild(newSemesterDiv);
                newGridDiv.addEventListener('dragleave', () => newGridDiv.classList.remove('highlight'));
                newGridDiv.addEventListener('dragover', dragOver);
                newGridDiv.addEventListener('drop', drop);
            }

            cleanupEmptySemesters();
            saveStateToLocalStorage();
        }

        function cleanupEmptySemesters() {
            const semesters = Array.from(document.querySelectorAll('.semester'));
            let lastNonEmptyIndex = -1;

            for (let i = semesters.length - 1; i >= 0; i--) {
                const semester = semesters[i];
                const coursesInSemester = semester.querySelectorAll('.course');
                if (coursesInSemester.length > 0) {
                    lastNonEmptyIndex = i;
                    break;
                }
            }

            for (let i = semesters.length - 1; i > lastNonEmptyIndex + 1; i--) {
                semesters[i].remove();
            }
        }

        function setErrorMessage(msg) {
            const errorDiv = document.getElementById('error-message');
            if (msg) {
                errorDiv.textContent = msg;
                errorDiv.style.display = 'block';
            } else {
                errorDiv.style.display = 'none';
            }
        }

        function clearErrorMessage() {
            setErrorMessage('');
        }

        function updateInfo() {
            const infoDiv = document.getElementById('info-message');
            const semesters = Array.from(document.querySelectorAll('.semester'));
            let totalCredits = 0;

            semesters.forEach(semester => {
                const coursesInSemester = semester.querySelectorAll('.course');
                coursesInSemester.forEach(course => {
                    const courseCredits = parseInt(course.dataset.credits, 10);
                    if (!isNaN(courseCredits)) {
                        totalCredits += courseCredits;
                    }
                });
            });

            const differenceAbsolute = Math.abs(180 - totalCredits);
            if (totalCredits === 180) {
                infoDiv.textContent = "You have all necessary credits.";
            } else if (totalCredits < 180) {
                infoDiv.textContent = `You have ${totalCredits} credits and need ${differenceAbsolute} more.`;
            } else if (totalCredits > 180) {
                infoDiv.textContent = `You have ${totalCredits} credits, which is ${differenceAbsolute} more than you need.`;
            }

            infoDiv.style.display = 'block';
        }

        function saveStateToLocalStorage() {
            const semesters = Array.from(document.querySelectorAll('.semester'));
            const state = semesters.map(semester => {
                const courses = Array.from(semester.querySelectorAll('.course')).map(course => {
                    return {
                        id: course.id,
                        short_name: course.dataset.short_name,
                        name: course.dataset.name,
                        credits: course.dataset.credits,
                        credits_needed: course.dataset.credits_needed,
                        semester: course.dataset.semester,
                        intendedSemester: course.dataset.intendedSemester,
                        prerequisites: JSON.parse(course.dataset.prerequisites),
                        isElective: course.dataset.isElective,
                        color: course.style.backgroundColor
                    };
                });
                return {
                    number: semester.dataset.number,
                    courses: courses
                };
            });

            localStorage.setItem('coursePlannerState', JSON.stringify(state));
        }

        function loadStateFromLocalStorage() {
            const state = localStorage.getItem('coursePlannerState');
            if (!state) return;

            const semestersData = JSON.parse(state);
            const semestersContainer = document.getElementById('semesters');
            semestersContainer.innerHTML = '';

            const placedElectives = new Set();

            semestersData.forEach(semesterData => {
                const semesterDiv = document.createElement('div');
                semesterDiv.className = 'semester';
                semesterDiv.dataset.number = semesterData.number;

                const semesterTitle = document.createElement('p');
                semesterTitle.textContent = `${semesterData.number}. Semester`;
                semesterDiv.appendChild(semesterTitle);

                const gridDiv = document.createElement('div');
                gridDiv.className = 'grid';
                semesterDiv.appendChild(gridDiv);

                semesterData.courses.forEach(courseData => {
                    const courseSquare = createCourseSquare(courseData, courseData.credits / 3);
                    gridDiv.appendChild(courseSquare);

                    if (courseData.isElective === 'true') {
                        placedElectives.add(courseData.short_name);
                    }
                });

                semestersContainer.appendChild(semesterDiv);
            });

            const electivesDiv = document.getElementById('electives');
            electivesDiv.innerHTML = '';

            const electivesCourses = courses.filter(course => course.elective === true && !placedElectives.has(course.short_name));
            electivesCourses.forEach(course => {
                const credits = course.credits / 3;
                const courseSquare = createCourseSquare(course, credits);
                electivesDiv.appendChild(courseSquare);
            });

            document.querySelectorAll('.grid').forEach(grid => {
                attachEventListenersToGrid(grid);
            });
        }

        function clearPlanner() {
            localStorage.removeItem('coursePlannerState');
            const semestersContainer = document.getElementById('semesters');
            semestersContainer.innerHTML = '';

            for (let semester = 1; semester <= 7; semester++) {
                const semesterDiv = document.createElement('div');
                semesterDiv.className = 'semester';
                semesterDiv.dataset.number = semester;

                const semesterTitle = document.createElement('p');
                semesterTitle.textContent = `${semester}. Semester`;
                semesterDiv.appendChild(semesterTitle);

                const gridDiv = document.createElement('div');
                gridDiv.className = 'grid';
                semesterDiv.appendChild(gridDiv);

                const semesterCourses = courses.filter(course => course.intended_semester === semester);
                semesterCourses.forEach(course => {
                    const credits = course.credits / 3;
                    const courseSquare = createCourseSquare(course, credits);
                    gridDiv.appendChild(courseSquare);
                });

                attachEventListenersToGrid(gridDiv);
                semestersContainer.appendChild(semesterDiv);
            }

            const electivesDiv = document.getElementById('electives');
            electivesDiv.innerHTML = '';

            const electivesCourses = courses.filter(course => course.elective === true);
            electivesCourses.forEach(course => {
                const credits = course.credits / 3;
                const courseSquare = createCourseSquare(course, credits);
                electivesDiv.appendChild(courseSquare);
            });

            updateInfo();
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadStateFromLocalStorage();

            document.querySelectorAll('.grid').forEach(grid => {
                attachEventListenersToGrid(grid);
            });

            document.querySelectorAll('.course').forEach(course => {
                attachEventListenersToCourse(course);
            });

            const clearButton = document.getElementById('clear-button');
            clearButton.addEventListener('click', clearPlanner);
        });

        function attachEventListenersToCourse(courseSquare) {
            courseSquare.addEventListener('dragstart', dragStart);
            courseSquare.addEventListener('dragover', dragOver);
            courseSquare.addEventListener('drop', drop);
        }

        function attachEventListenersToGrid(grid) {
            grid.addEventListener('dragleave', () => grid.classList.remove('highlight'));
            grid.addEventListener('dragover', dragOver);
            grid.addEventListener('drop', drop);
        }
    </script>
</body>
</html>