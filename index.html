<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Planner</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .electives-container {
            width: 800px;
            display: flex;
            flex-wrap: wrap; 
            gap: 5px; 
            background-color: #f0f0f0;
            padding: 5px;
            margin-bottom: 10px;
        }

        .semester {
            margin-bottom: 20px;
            display: flex;
        }
        .semester p {
            margin-right: 10px;
        }



        .grid {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            background-color: #f0f0f0;
            padding: 5px;
            border-radius: 5px;
            width: max-content;
            min-width: 545px;
            height: 50px;
        }
        .grid.highlight {
            outline: 2px dashed #007bff;
        }

        .square {
            width: 50px;
            height: 50px;
            background-color: #e0e0e0;
            border: 1px solid #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .course {
            color: black;
            cursor: grab;
        }
        .course:active {
            cursor: grabbing;
        }
        .course-joined {
            width: calc(50px * var(--credits) + 5px * (var(--credits) - 1));
        }
        
    </style>
</head>
<body>
    <h1>Course Planner</h1>
    <div id="error-message" ></div>
    <div id="electives" class="electives-container "></div>
    <div id="semesters" class="semester-container"></div>
    <script type="module" src="courses.js"></script>
    <script>
courses = [
    {
        "short_name": "SE1",
        "name": "Software Engineering 1",
        "credits": 6,
        "semester": "winter",
        "intended_semester": 1,
        "prerequisites": [],
        "credits_needed": 0,
        "elective": false,
        "color": "#759fec"
    },
    {
        "short_name": "IKON",
        "name": "Introduction to Computer Networks",
        "credits": 6,
        "semester": "winter",
        "intended_semester": 1,
        "prerequisites": [],
        "credits_needed": 0,
        "elective": false,
        "color": "#759fec"
    },
    {
        "short_name": "DM",
        "name": "Discrete Mathematics",
        "credits": 9,
        "semester": "winter",
        "intended_semester": 1,
        "prerequisites": [],
        "credits_needed": 0,
        "elective": false,
        "color": "#54fdfd"
    },
    {
        "short_name": "RSB",
        "name": "Requirements Engineering and Software Design",
        "credits": 9,
        "semester": "winter",
        "intended_semester": 1,
        "prerequisites": [],
        "credits_needed": 0,
        "elective": false,
        "color": "#c4cbd1"
    },
    {
        "short_name": "SE2",
        "name": "Software Engineering 2",
        "credits": 6,
        "semester": "summer",
        "intended_semester": 2,
        "prerequisites": [],
        "credits_needed": 0,
        "elective": false,
        "color": "#759fec"
    },
    {
        "short_name": "ALA",
        "name": "Algorithms and Data Structures",
        "credits": 9,
        "semester": "summer",
        "intended_semester": 2,
        "prerequisites": [],
        "credits_needed": 0,
        "elective": false,
        "color": "#54fdfd"
    },
    {
        "short_name": "Pros",
        "name": "ProSeminar",
        "credits": 3,
        "semester": "both",
        "intended_semester": 2,
        "prerequisites": [],
        "credits_needed": 0,
        "elective": false,
        "color": "#effdb2"
    },
    {
        "short_name": "VSS",
        "name": "Verification of Software Systems",
        "credits": 6,
        "semester": "summer",
        "intended_semester": 2,
        "prerequisites": [],
        "credits_needed": 0,
        "elective": false,
        "color": "#c4cbd1"
    },
    {
        "short_name": "ETI",
        "name": "Ethics in Technology and Innovation",
        "credits": 6,
        "semester": "summer",
        "intended_semester": 2,
        "prerequisites": [],
        "credits_needed": 0,
        "elective": false,
        "color": "#54fdfd"
    },
    {
        "short_name": "AD",
        "name": "Advanced Databases",
        "credits": 6,
        "semester": "winter",
        "intended_semester": 3,
        "prerequisites": ["SE1"],
        "credits_needed": 0,
        "elective": false,
        "color": "#54fdfd"
    },
    {
        "short_name": "MK",
        "name": "Methodenkompetenz",
        "credits": 3,
        "semester": "both",
        "intended_semester": 3,
        "prerequisites": [],
        "credits_needed": 0,
        "elective": false,
        "color": "#effdb2"
    },
    {
        "short_name": "BKA",
        "name": "Business Knowledge and Applications",
        "credits": 6,
        "semester": "summer",
        "intended_semester": 4,
        "prerequisites": [],
        "credits_needed": 0,
        "elective": false,
        "color": "#54fdfd"
    },
    {
        "short_name": "Stoch1",
        "name": "Stochastic Processes 1",
        "credits": 6,
        "semester": "summer",
        "intended_semester": 4,
        "prerequisites": [],
        "credits_needed": 0,
        "elective": false,
        "color": "#54fdfd"
    },
    {
        "short_name": "Prak",
        "name": "Praktikum",
        "credits": 9,
        "semester": "both",
        "intended_semester": 4,
        "prerequisites": ["SE1"],
        "credits_needed": 51,
        "elective": false,
        "color": "#ff9a6c"
    },
    {
        "short_name": "Proj",
        "name": "Project",
        "credits": 9,
        "semester": "both",
        "intended_semester": 5,
        "prerequisites": ["SE1", "SE2", "Pros", "Prak"],
        "credits_needed": 80,
        "elective": false,
        "color": "#ff9a6c"
    },
    {
        "short_name": "Sem",
        "name": "Seminar",
        "credits": 3,
        "semester": "both",
        "intended_semester": 5,
        "prerequisites": ["Pros"],
        "credits_needed": 51,
        "elective": false,
        "color": "#ff9a6c"
    },
    {
        "short_name": "Abschlussmodul",
        "name": "Final Module",
        "credits": 12,
        "semester": "both",
        "intended_semester": 6,
        "prerequisites": ["SE1", "RSB", "DM", 
                          "ALA", "VSS", "SE2", "ETI", "Pros",
                          "AD", "MK", 
                          "BKA", "Stoch1", "Prak" ],
        "credits_needed": 0,
        "elective": false,
        "color": "#ec9393"
    },
    {
        "short_name": "ATI",
        "name": "Aktuelle Themen der Theoretischen Informatik",
        "credits": 6,
        "semester": "winter",
        "intended_semester": null,
        "prerequisites": [],
        "credits_needed": 0,
        "elective": true,
        "color": "#ffffff"
    },
    {
        "short_name": "CN",
        "name": "Rechnernetze",
        "credits": 6,
        "semester": "winter",
        "intended_semester": null,
        "prerequisites": [],
        "credits_needed": 0,
        "elective": true,
        "color": "#ffffff"
    },
    {
        "short_name": "EML",
        "name": "Einführung in das Maschinelle Lernen",
        "credits": 6,
        "semester": "winter",
        "intended_semester": null,
        "prerequisites": [],
        "credits_needed": 0,
        "elective": true,
        "color": "#ffffff"
    },
    {
        "short_name": "GDB",
        "name": "Grundlagen von Datenbanken",
        "credits": 6,
        "semester": "winter",
        "intended_semester": null,
        "prerequisites": [],
        "credits_needed": 0,
        "elective": true,
        "color": "#ffffff"
    },
    {
        "short_name": "ICG",
        "name": "Interaktive Computergrafik",
        "credits": 6,
        "semester": "winter",
        "intended_semester": null,
        "prerequisites": [],
        "credits_needed": 0,
        "elective": true,
        "color": "#ffffff"
    },
    {
        "short_name": "HLR",
        "name": "Hochleistungsrechnen",
        "credits": 9,
        "semester": "winter",
        "intended_semester": null,
        "prerequisites": ["SE1"],
        "credits_needed": 0,
        "elective": true,
        "color": "#ffffff"
    },
    {
        "short_name": "MAKS",
        "name": "Modellierung und Analyse komplexer Systeme",
        "credits": 9,
        "semester": "winter",
        "intended_semester": null,
        "prerequisites": [],
        "credits_needed": 0,
        "elective": true,
        "color": "#ffffff"
    },
    {
        "short_name": "PM",
        "name": "Projektmanagement",
        "credits": 3,
        "semester": "winter",
        "intended_semester": null,
        "prerequisites": [],
        "credits_needed": 0,
        "elective": true,
        "color": "#ffffff"
    },
    {
        "short_name": "OPT",
        "name": "Optimierung für Studierende der Informatik",
        "credits": 6,
        "semester": "winter",
        "intended_semester": null,
        "prerequisites": [],
        "credits_needed": 0,
        "elective": true,
        "color": "#ffffff"
    },
    {
        "short_name": "STO2",
        "name": "Stochastik 2 für Studierende der Informatik",
        "credits": 6,
        "semester": "winter",
        "intended_semester": null,
        "prerequisites": [],
        "credits_needed": 0,
        "elective": true,
        "color": "#ffffff"
    },
    {
        "short_name": "BV",
        "name": "Einführung in die Bildverarbeitung",
        "credits": 6,
        "semester": "summer",
        "intended_semester": null,
        "prerequisites": [],
        "credits_needed": 0,
        "elective": true,
        "color": "#ffffff"
    },
    {
        "short_name": "DAIS",
        "name": "Data-driven Intelligent Systems",
        "credits": 9,
        "semester": "summer",
        "intended_semester": null,
        "prerequisites": ["SE1", "SE2", "ETI"],
        "credits_needed": 51,
        "elective": true,
        "color": "#ffffff"
    },
    {
        "short_name": "DIG",
        "name": "Datenschutz in der Informationsgesellschaft",
        "credits": 3,
        "semester": "summer",
        "intended_semester": null,
        "prerequisites": [],
        "credits_needed": 0,
        "elective": true,
        "color": "#ffffff"
    },
    {
        "short_name": "DMSV",
        "name": "Digitale Medien- und Signalverarbeitung",
        "credits": 9,
        "semester": "summer",
        "intended_semester": null,
        "prerequisites": [],
        "credits_needed": 0,
        "elective": true,
        "color": "#ffffff"
    },
    {
        "short_name": "DV",
        "name": "Datenvisualisierung",
        "credits": 6,
        "semester": "summer",
        "intended_semester": null,
        "prerequisites": ["SE1"],
        "credits_needed": 51,
        "elective": true,
        "color": "#ffffff"
    },
    {
        "short_name": "ES",
        "name": "Eingebettete Systeme",
        "credits": 9,
        "semester": "summer",
        "intended_semester": null,
        "prerequisites": ["RSB"],
        "credits_needed": 51,
        "elective": true,
        "color": "#ffffff"
    },
    {
        "short_name": "ESM",
        "name": "Einführung in die System-Medizin – Mit Big Data gegen Krebs und Volkskrankheiten",
        "credits": 6,
        "semester": "summer",
        "intended_semester": null,
        "prerequisites": ["SE1", "SE2"],
        "credits_needed": 51,
        "elective": true,
        "color": "#ffffff"
    },
    {
        "short_name": "ID",
        "name": "Interaktionsdesign",
        "credits": 6,
        "semester": "summer",
        "intended_semester": null,
        "prerequisites": ["SE1", "SE2", "IKON"],
        "credits_needed": 51,
        "elective": true,
        "color": "#ffffff"
    },
    {
        "short_name": "IGMO",
        "name": "Informatikgestützte Gestaltung und Modellierung von Organisationen",
        "credits": 9,
        "semester": "summer",
        "intended_semester": null,
        "prerequisites": ["SE1", "SE2", "IKON"],
        "credits_needed": 51,
        "elective": true,
        "color": "#ffffff"
    },
    {
        "short_name": "SWT",
        "name": "SWT",
        "credits": 9,
        "semester": "summer",
        "intended_semester": null,
        "prerequisites": ["SE1", "SE2"],
        "credits_needed": 0,
        "elective": true,
        "color": "#ffffff"
    },
    {
        "short_name": "MOBS",
        "name": "Moderne Betriebssysteme",
        "credits": 6,
        "semester": "summer",
        "intended_semester": null,
        "prerequisites": [],
        "credits_needed": 0,
        "elective": true,
        "color": "#ffffff"
    },
    {
        "short_name": "PGIT",
        "name": "Philosophie, Gesellschaft und IT",
        "credits": 6,
        "semester": "summer",
        "intended_semester": null,
        "prerequisites": [],
        "credits_needed": 0,
        "elective": true,
        "color": "#ffffff"
    },
    {
        "short_name": "SEW",
        "name": "Softwareentwurf",
        "credits": 6,
        "semester": "summer",
        "intended_semester": null,
        "prerequisites": [],
        "credits_needed": 0,
        "elective": true,
        "color": "#ffffff"
    },
    {
        "short_name": "UrhR",
        "name": "Urheberrecht in der Informationsgesellschaft",
        "credits": 3,
        "semester": "summer",
        "intended_semester": null,
        "prerequisites": [],
        "credits_needed": 0,
        "elective": true,
        "color": "#ffffff"
    }
]

const semestersContainer = document.getElementById('semesters');

// Create a mapping of each course to the courses that depend on it
const courseDependencies = {};
courses.forEach(course => {
    course.prerequisites.forEach(prerequisite => {
        if (!courseDependencies[prerequisite]) {
            courseDependencies[prerequisite] = [];
        }
        courseDependencies[prerequisite].push(course.short_name);
    });
});

// Create a grid for each semester (1 to 6)
for (let semester = 1; semester <= 7; semester++) {
    const semesterDiv = document.createElement('div');
    semesterDiv.className = 'semester';

    semesterDiv.dataset.number = semester

    const semesterTitle = document.createElement('p');
    semesterTitle.textContent = `${semester}. FS`;
    semesterDiv.appendChild(semesterTitle);

    const gridDiv = document.createElement('div');
    gridDiv.className = 'grid';


    // Add courses to the grid
    const semesterCourses = courses.filter(course => course.intended_semester === semester);
    semesterCourses.forEach(course => {
        const credits = course.credits / 3; // Each square represents 3 credits
        const courseSquare = document.createElement('div');
        courseSquare.className = 'square course course-joined';
        courseSquare.style.setProperty('--credits', credits); 
        courseSquare.textContent = course.short_name;
        courseSquare.draggable = true;
        courseSquare.id = `course-${course.id}`; // Unique ID for each course
        courseSquare.style.backgroundColor = course.color


        courseSquare.dataset.short_name = course.short_name;
        courseSquare.dataset.name = course.name;
        courseSquare.dataset.credits = course.credits;
        courseSquare.dataset.credits_needed = course.credits_needed;
        courseSquare.dataset.semester = course.semester;
        courseSquare.dataset.intendedSemester = course.intended_semester;
        courseSquare.dataset.prerequisites = JSON.stringify(course.prerequisites);
        courseSquare.dataset.isElective = course.elective;

        // Drag and Drop event listeners
        courseSquare.addEventListener('dragstart', dragStart);
        courseSquare.addEventListener('dragover', dragOver);
        courseSquare.addEventListener('drop', drop);

        gridDiv.appendChild(courseSquare);
    });

    semesterDiv.appendChild(gridDiv);
    semestersContainer.appendChild(semesterDiv);
}

// Space for electives
const electivesDiv = document.getElementById('electives');
const electivesCourses = courses.filter(course => course.elective === true);
electivesCourses.forEach(course => {
    const credits = course.credits / 3; // Each square represents 3 credits
    const courseSquare = document.createElement('div');
    courseSquare.className = 'square course course-joined';
    courseSquare.style.setProperty('--credits', credits); 
    courseSquare.textContent = course.short_name;
    courseSquare.draggable = true;
    courseSquare.id = `course-${course.id}`; // Unique ID for each course

    courseSquare.style.backgroundColor = course.color

    courseSquare.dataset.short_name = course.short_name;
    courseSquare.dataset.name = course.name;
    courseSquare.dataset.credits = course.credits;
    courseSquare.dataset.credits_needed = course.credits_needed;
    courseSquare.dataset.semester = course.semester;
    courseSquare.dataset.intendedSemester = course.intended_semester;
    courseSquare.dataset.prerequisites = JSON.stringify(course.prerequisites);
    courseSquare.dataset.isElective = course.elective;


    // Drag and Drop event listeners
    courseSquare.addEventListener('dragstart', dragStart);
    courseSquare.addEventListener('dragover', dragOver);
    courseSquare.addEventListener('drop', drop);

    electivesDiv.appendChild(courseSquare);
});





document.querySelectorAll('.grid').forEach(grid => {
    grid.addEventListener('dragleave', () => grid.classList.remove('highlight'));
    grid.addEventListener('dragover', dragOver);
    grid.addEventListener('drop', drop);
    document.addEventListener('dragend', restoreOpacity);
});

let draggedCourse = null;

function dragStart(event) {
    draggedCourse = event.target;
    event.dataTransfer.setData('text/plain', event.target.id);

    // for reduced opacity 
    const allSemesterDivs = document.querySelectorAll('.semester');
    const draggedSquareSemesterType = draggedCourse.dataset.semester;
    allSemesterDivs.forEach(semesterDiv => {
        const isWinterSemesterDragStart = semesterDiv.dataset.number % 2 !== 0;
        
        // If the dragged course is 'summer' and the div represents 'winter', reduce opacity
        if (draggedSquareSemesterType === 'summer' && isWinterSemesterDragStart) {
            semesterDiv.style.opacity = '0.3'; // Reduce opacity of winter courses
        } 
        // If the dragged course is 'winter' and the div represents 'summer', reduce opacity
        else if (draggedSquareSemesterType === 'winter' && !isWinterSemesterDragStart) {
            semesterDiv.style.opacity = '0.3'; // Reduce opacity of summer courses
        } 
        // If the dragged course is 'both', don't alter opacity
        else if (draggedSquareSemesterType === 'both') {
            semesterDiv.style.opacity = '1'; // Ensure opacity is reset for both cases
        } 
        // Reset opacity for all other cases
        else {
            semesterDiv.style.opacity = '1';
        }
    });
}

function restoreOpacity() {
    const allSemesterDivs = document.querySelectorAll('.semester');
    allSemesterDivs.forEach(semesterDiv => {semesterDiv.style.opacity = '1';});
}


function dragOver(event) { //TODO: only if semester type matches
    event.preventDefault();
    event.target.closest('.grid')?.classList.add('highlight');
}

function drop(event) {
    event.preventDefault();

    restoreOpacity()

    const targetSemesterGrid = event.target.closest('.grid');
    targetSemesterGrid.classList.remove('highlight');

    if (!targetSemesterGrid || !draggedCourse) return;

    const targetSemesterDiv = targetSemesterGrid.closest('.semester');
    const semesterNumber = parseInt(targetSemesterDiv.dataset.number);
    const isWinterSemester = semesterNumber % 2 !== 0;
    const courseSemesterType = draggedCourse.dataset.semester;

    // Check if the course can be placed in the target semester based on its semester type
    if (
        (isWinterSemester && courseSemesterType === "summer") ||  // Winter semester but course is for summer
        (!isWinterSemester && courseSemesterType === "winter")    // Summer semester but course is for winter
    ) {
        console.warn(`Cannot move ${draggedCourse.dataset.name} to semester ${semesterNumber}. Semester type mismatch.`);
        setErrorMessage(`Cannot move ${draggedCourse.dataset.name} to semester ${semesterNumber}. Semester type mismatch.`)
        return;
    }

    // Extract prerequisites and credits needed for the course being moved
    const prerequisites = JSON.parse(draggedCourse.dataset.prerequisites);
    const creditsNeeded = parseInt(draggedCourse.dataset.credits_needed);

    // console.log("prerequisites: " + prerequisites + " creditsNeeded: " + creditsNeeded);

    // Get all previous semesters (semesters before the target semester)
    const previousSemesters = Array.from(document.querySelectorAll('.semester'))
        .filter(semester => parseInt(semester.dataset.number) < semesterNumber);

    const allSemesters = Array.from(document.querySelectorAll('.semester')) //maybe join with the previous semester thing
    const allCourses = new Map()
    allSemesters.forEach((semester, semesterIndex) => {
        const coursesInSemester = semester.querySelectorAll('.course');
        coursesInSemester.forEach(course => {
            allCourses.set(course.dataset.short_name, semesterIndex+1);
        });
    });
    // console.log("allCourses: ")
    // console.log(allCourses)

    // Track completed courses and total credits from previous semesters
    const completedCourses = new Set();
    let totalCreditsByPreviousSemester = 0;

    previousSemesters.forEach(semester => {
        const coursesInSemester = semester.querySelectorAll('.course');
        coursesInSemester.forEach(course => {
            completedCourses.add(course.dataset.short_name);

            // Ensure dataset.credits exists and is a valid number
            const courseCredits = parseInt(course.dataset.credits, 10);
            if (!isNaN(courseCredits)) {
                totalCreditsByPreviousSemester += courseCredits;
            } else {
                console.warn(`Invalid credits for course: ${course.dataset.short_name}`, course.dataset.credits);
            }
        });
    });

    // console.log("previousSemesters:", previousSemesters);
    // console.log("completedCourses:", Array.from(completedCourses));
    // console.log("totalCreditsByPreviousSemester:", totalCreditsByPreviousSemester);

    // Check if prerequisites are met
    const prerequisitesMet = prerequisites.every(prerequisite => completedCourses.has(prerequisite));
    const missingPrerequisites = prerequisites.filter(prerequisite => !completedCourses.has(prerequisite));

    // Check if credits needed are met
    const gotNeededCredits = totalCreditsByPreviousSemester >= creditsNeeded;
    const creditDifference = creditsNeeded - totalCreditsByPreviousSemester;

    // If prerequisites or credits are not met, block the move
    if (!prerequisitesMet) {
        console.warn(`Cannot move ${draggedCourse.dataset.name} to semester ${semesterNumber}. Course prerequisites not met:  ${missingPrerequisites}`);
        setErrorMessage(`Cannot move ${draggedCourse.dataset.name} to semester ${semesterNumber}. Course prerequisites not met: ${missingPrerequisites}`);
        return;
    } else if (!gotNeededCredits) {
        console.warn(`Cannot move ${draggedCourse.dataset.name} to semester ${semesterNumber}. You need ${creditDifference} more credits.`);
        setErrorMessage(`Cannot move ${draggedCourse.dataset.name} to semester ${semesterNumber}. You need ${creditDifference} more credits.`);
        return;
    }

    // Check if the dragged course is a prerequisite for any other course
    const courseName = draggedCourse.dataset.short_name;
    console.log("courseName: "+courseName)
    if (courseDependencies[courseName]) {
        console.log("courseDependencies[courseName]:")
        console.log(courseDependencies[courseName])
        for (const dependent of courseDependencies[courseName]) { // Check if that dependant will be broken by the move
            if (!allCourses.has(dependent)) continue; // Skip if course not found

            const dependentSemester = allCourses.get(dependent);
            if (semesterNumber >= dependentSemester) { 
                console.warn(`Moving ${courseName} will break prerequisites for ${dependent} (currently in semester ${dependentSemester})`);
                setErrorMessage(`Moving ${courseName} will break prerequisites for ${dependent}`);

                return;
            }
        }
    }

    // If all checks pass, move the course to the target semester
    targetSemesterGrid.appendChild(draggedCourse);
    draggedCourse = null;
    clearErrorMessage();
}

function setErrorMessage(msg) {
  const errorDiv = document.getElementById('error-message');
  if (msg) {
    errorDiv.textContent = msg;
    errorDiv.style.display = 'block'; // Show the error message div
  } else {
    errorDiv.style.display = 'none'; // Hide the error message div
  }
}

function clearErrorMessage() {
  setErrorMessage(''); // Clears the message by passing an empty string
}

</script>
</body>
</html>